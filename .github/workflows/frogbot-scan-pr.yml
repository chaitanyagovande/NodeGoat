name: "Frogbot Security Scan"

on:
  pull_request_target: 
    types: [opened, synchronize] # Triggers scan-pr flow for every opened/updated pull request
  push: # Triggers scan-repo flow for every push to the specified branches
    branches:
      - master
  schedule:
    - cron: "0 0 * * *"   # The repository will be scanned once a day at 00:00 GMT.
  workflow_dispatch: # The repository will be scanned on demand

permissions:
  pull-requests: write
  contents: write
  security-events: write
  # [Mandatory If using OIDC authentication protocol instead of JF_ACCESS_TOKEN]
  id-token: write

jobs:
  frogbot-scan:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        # The repository scanning will be triggered periodically on the following branches.
        branch: ["master"]
    steps:
      - name: "Run Frogbot Scan"
        uses: jfrog/frogbot@v2
        # [Mandatory if using OIDC authentication protocol instead of JF_ACCESS_TOKEN]
        # Insert to oidc-provider-name the 'Provider Name' defined in the OIDC integration configured in the JPD
        id: frogbot
        with:
          oidc-provider-name: ${{vars.JF_OIDC_PROVIDER_NAME}}
          add-run-summary: true
        env:
          JF_URL: ${{ secrets.JF_URL }}
          JF_GIT_TOKEN: ${{ secrets.JF_GITHUB_TOKEN }}
          JF_GIT_BASE_BRANCH: ${{ matrix.branch }}    # For repository scan action
          JF_WATCHES: "BD_BY_TEST_LIC_EXT_UB"
          #JFROG_CLI_LOG_LEVEL: "DEBUG"
      
      # A custom step to write to the summary
      - name: Add Frogbot status to summary
        run: |
          echo "### 🐸 Frogbot Scan Results" >> $GITHUB_STEP_SUMMARY
          
          # This is a hypothetical example. You would need to check
          # if the 'jfrog/frogbot' action provides any usable outputs
          # like 'exit_code' or a JSON results path.
          
          if [ "${{ steps.frogbot.outputs.scan-exit-code }}" == "0" ]; then
            echo "✅ **Scan complete:** No new vulnerabilities found." >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ **Scan complete:** Vulnerabilities were found." >> $GITHUB_STEP_SUMMARY
            echo "Please check the pull request comments or the 'Security' tab for details." >> $GITHUB_STEP_SUMMARY
          fi
